{% doc %}
  Product Buy Form

  Renders the product purchase form with variant options displayed in a three-column grid and support for a larger primary button.

  @param {product} product - Product object to use (optional, defaults to global product)
  @param {boolean} show_dynamic_checkout - Display dynamic checkout buttons (default: false)
  @param {boolean} gift_card_recipient_feature_active - Hide errors when gift card recipient feature is active (default: false)
  @param {string} section_id - Section identifier used for DOM scoping (optional)
  @param {string} product_form_id - Explicit form identifier (optional)
  @param {boolean} quantity_rule_soldout - Flag from parent context indicating quantity rule sold out (default: false)
{% enddoc %}

{% liquid
  assign show_dynamic_checkout = show_dynamic_checkout | default: false
  assign gift_card_recipient_feature_active = gift_card_recipient_feature_active | default: false
  assign section_id_value = section_id | default: 'main-product'
  assign product_form_id = product_form_id | default: section_id_value | append: '-product-form'
  assign quantity_rule_soldout = quantity_rule_soldout | default: false
%}

<product-form
  class="product-form"
  data-hide-errors="{{ gift_card_recipient_feature_active }}"
  data-section-id="{{ section_id_value }}"
  data-product-id="{{ product.id }}"
>
  <div class="product-form__error-message-wrapper" role="alert" hidden>
    <span class="svg-wrapper">
      {{- 'icon-error.svg' | inline_asset_content -}}
    </span>
    <span class="product-form__error-message"></span>
  </div>

  {%- form 'product',
    product,
    id: product_form_id,
    class: 'form',
    novalidate: 'novalidate',
    data-type: 'add-to-cart-form'
  -%}
    <input
      type="hidden"
      name="id"
      value="{{ product.selected_or_first_available_variant.id }}"
      {% if product.selected_or_first_available_variant.available == false
        or quantity_rule_soldout
        or product.selected_or_first_available_variant == null
      %}
        disabled
      {% endif %}
      class="product-variant-id"
    >
    <div class="flex flex-col gap-4">
      {% unless product.has_only_default_variant %}
        <div class="flex flex-col gap-4">
          {% for option in product.options_with_values %}
            <div class="grid grid-cols-3 gap-3 w-full">
              {% for value in option.values %}
                <label
                  for="product-options[{{ option.name }}]-{{ forloop.index }}"
                  class="group relative flex items-center justify-center px-3 py-3 gap-2 border bg-white rounded-md cursor-pointer transition-all border-neutral-200 hover:bg-neutral-100 data-[selected=true]:border-[var(--product-accent)]  data-[selected=true]:[background:var(--product-background)]"
                  data-option-label
                  {% if option.selected_value == value %}
                    data-selected="true"
                  {% else %}
                    data-selected="false"
                  {% endif %}
                >
                  <input
                    type="radio"
                    id="product-options[{{ option.name }}]-{{ forloop.index }}"
                    name="options[{{ option.name }}]"
                    value="{{ value }}"
                    {% if option.selected_value == value %}
                      checked
                    {% endif %}
                    class="sr-only"
                  >
                  <span class="font-medium text-primary group-data-[selected=true]:text-[var(--product-accent)]">
                    {{- value -}}
                  </span>
                  <span
                    class="hidden text-xs font-medium px-1.5 py-0.5 tabular-nums rounded-full bg-[var(--product-accent)] text-[var(--product-button-text-color)] whitespace-nowrap"
                    data-variant-badge
                  ></span>
                </label>
              {% endfor %}
            </div>
          {% endfor %}
        </div>
      {% endunless %}

      <div class="product-form__buttons">
        {%- liquid
          assign check_against_inventory = true
          if product.selected_or_first_available_variant.inventory_management != 'shopify' or product.selected_or_first_available_variant.inventory_policy == 'continue'
            assign check_against_inventory = false
          endif
          if product.selected_or_first_available_variant.quantity_rule.min > product.selected_or_first_available_variant.inventory_quantity and check_against_inventory
            assign quantity_rule_soldout = true
          endif
        -%}
        <button
          id="ProductSubmitButton-{{ section_id_value }}"
          type="submit"
          name="add"
          class="button flex items-center gap-2 h-14 px-7 text-base [background:var(--product-button-background)] [color:var(--product-button-text-color)] w-full"
          {% if product.selected_or_first_available_variant.available == false
            or quantity_rule_soldout
            or product.selected_or_first_available_variant == null
          %}
            disabled
          {% endif %}
        >
          <div class="size-6">
            {{ 'icon-cart.svg' | inline_asset_content }}
          </div>
          <span>
            {%- if product.selected_or_first_available_variant == null -%}
              Unavailable
            {%- elsif product.selected_or_first_available_variant.available == false or quantity_rule_soldout -%}
              Sold out
            {%- else -%}
              Add to cart ({{ product.selected_or_first_available_variant.price | money }})
            {%- endif -%}
          </span>
          <span class="text-base font-medium text-white/"> </span>
          {% comment %} {%- render 'loading-spinner' -%} {% endcomment %}
        </button>
        {%- if show_dynamic_checkout -%}
          {{ form | payment_button }}
        {%- endif -%}
      </div>
    </div>
  {%- endform -%}
</product-form>

{% javascript %}
  // Prevent clicks on variant options and buttons from propagating to parent link
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('product-form').forEach(function (productForm) {
      // Stop propagation for clicks on variant options and form buttons
      const interactiveElements = productForm.querySelectorAll(
        '[data-option-label], .product-form__submit, input[type="radio"], button[type="submit"]'
      );

      interactiveElements.forEach(function (element) {
        // Handle both click and touch events for mobile compatibility
        function handleInteraction(e) {
          // Stop propagation to prevent navigation when clicking on form controls
          e.stopPropagation();
          // Prevent default only if it's a link
          if (e.target.closest('a')) {
            e.preventDefault();
          }
        }

        element.addEventListener('click', handleInteraction);
        element.addEventListener('touchend', function (e) {
          handleInteraction(e);
          // Trigger click for accessibility and form submission
          if (!e.defaultPrevented) {
            const clickEvent = new MouseEvent('click', {
              bubbles: true,
              cancelable: true,
              view: window,
            });
            element.dispatchEvent(clickEvent);
          }
        });
      });
    });
  });
{% endjavascript %}
