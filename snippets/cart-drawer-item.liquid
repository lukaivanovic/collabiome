{% doc %}
  Cart Drawer Item Component

  Renders a single cart item card with all details, quantity controls, and pricing.

  @param {object} item - Cart item object (required)

  @example
  {% render 'cart-drawer-item', item: item %}
{% enddoc %}

{% liquid
  assign item = item | default: empty

  unless item != empty
    echo '<!-- Error: item parameter required for cart-drawer-item snippet -->'
    break
  endunless

  assign has_qty_rules = false
  if item.variant.quantity_rule.increment > 1 or item.variant.quantity_rule.min > 1 or item.variant.quantity_rule.max != null
    assign has_qty_rules = true
  endif

  assign has_vol_pricing = false
  if item.variant.quantity_price_breaks.size > 0
    assign has_vol_pricing = true
  endif
%}

<div
  id="CartDrawer-Item-{{ item.index | plus: 1 }}"
  class="cart-item-card bg-white border border-neutral-200 rounded-lg p-4{% if item.parent_relationship.parent != null %} cart-item__nested-line{% endif %}"
  {% if item.parent_relationship.parent != null %}
    aria-label="{{ item.product.title | escape }} part of {{ item.parent_relationship.parent.title | escape }}"
  {% endif %}
>
  <div class="flex gap-4">
    {%- comment -%} Product Image {%- endcomment -%}
    <div class="cart-item__media flex-shrink-0">
      {% if item.image %}
        <a href="{{ item.url }}" class="block">
          <img
            class="cart-item__image rounded-md w-24 h-24 object-cover"
            src="{{ item.image | image_url: width: 300 }}"
            alt="{{ item.image.alt | escape }}"
            loading="lazy"
            width="96"
            height="96"
          >
        </a>
      {% endif %}
    </div>

    {%- comment -%} Product Details {%- endcomment -%}
    <div class="flex-1 flex flex-col gap-2">
      {%- if settings.show_vendor -%}
        <p class="text-xs text-neutral-500 uppercase tracking-wide">{{ item.product.vendor }}</p>
      {%- endif -%}

      <a href="{{ item.url }}" class="cart-item__name font-semibold text-base hover:underline">
        {{- item.product.title | escape -}}
      </a>

      {%- comment -%} Price {%- endcomment -%}
      {%- if item.original_price != item.final_price -%}
        <div class="flex items-center gap-2">
          <span class="visually-hidden">{{ 'products.product.price.regular_price' | t }}</span>
          <s class="text-sm text-neutral-500">
            {{- item.original_price | money -}}
          </s>
          <span class="visually-hidden">{{ 'products.product.price.sale_price' | t }}</span>
          <strong class="text-sm font-semibold text-red-600">
            {{ item.final_price | money }}
          </strong>
        </div>
      {%- else -%}
        <div class="text-sm">
          {{ item.original_price | money }}
        </div>
      {%- endif -%}

      {%- comment -%} Variants & Options {%- endcomment -%}
      {%- if item.product.has_only_default_variant == false
        or item.properties.size != 0
        or item.selling_plan_allocation != null
      -%}
        <dl class="text-sm text-neutral-600">
          {%- if item.product.has_only_default_variant == false -%}
            {%- for option in item.options_with_values -%}
              <div class="flex gap-1">
                <dt class="font-medium">{{ option.name }}:</dt>
                <dd>{{ option.value }}</dd>
              </div>
            {%- endfor -%}
          {%- endif -%}

          {%- for property in item.properties -%}
            {%- assign property_first_char = property.first | slice: 0 -%}
            {%- if property.last != blank and property_first_char != '_' -%}
              <div class="flex gap-1">
                <dt class="font-medium">{{ property.first }}:</dt>
                <dd>
                  {%- if property.last contains '/uploads/' -%}
                    <a
                      href="{{ property.last }}"
                      class="underline"
                      target="_blank"
                      aria-describedby="a11y-new-window-message"
                    >
                      {{ property.last | split: '/' | last }}
                    </a>
                  {%- else -%}
                    {{ property.last }}
                  {%- endif -%}
                </dd>
              </div>
            {%- endif -%}
          {%- endfor -%}
        </dl>

        {%- if item.selling_plan_allocation.selling_plan.name -%}
          <p class="text-sm text-neutral-600">{{ item.selling_plan_allocation.selling_plan.name }}</p>
        {%- endif -%}
      {%- endif -%}

      {%- comment -%} Discounts {%- endcomment -%}
      {%- if item.line_level_discount_allocations.size > 0 -%}
        <ul class="flex flex-col gap-1" role="list" aria-label="{{ 'customer.order.discount' | t }}">
          {%- for discount in item.line_level_discount_allocations -%}
            <li class="flex items-center gap-1 text-sm text-green-600">
              <span class="svg-wrapper w-4 h-4">
                {{- 'icon-discount.svg' | inline_asset_content -}}
              </span>
              {{ discount.discount_application.title }}
            </li>
          {%- endfor -%}
        </ul>
      {%- endif -%}
    </div>

    {%- comment -%} Line Total Price {%- endcomment -%}
    <div class="flex-shrink-0 text-right">
      {%- if item.original_line_price != item.final_line_price -%}
        <div class="flex flex-col gap-1">
          <span class="visually-hidden">{{ 'products.product.price.regular_price' | t }}</span>
          <s class="text-sm text-neutral-500">
            {{ item.original_line_price | money }}
          </s>
          <span class="visually-hidden">{{ 'products.product.price.sale_price' | t }}</span>
          <span class="font-semibold">
            {{ item.final_line_price | money }}
          </span>
        </div>
      {%- else -%}
        <span class="font-semibold">
          {{ item.original_line_price | money }}
        </span>
      {%- endif -%}
    </div>
  </div>

  {%- comment -%} Quantity Controls & Remove Button {%- endcomment -%}
  <div class="mt-4 flex items-center justify-between border-t border-neutral-200 pt-4">
    <quantity-popover>
      <div class="flex items-center gap-3">
        {%- comment -%} Quantity Input {%- endcomment -%}
        <quantity-input class="quantity cart-quantity">
          <div class="flex items-center border border-neutral-300 rounded-md overflow-hidden">
            <button
              class="quantity__button px-3 py-2 hover:bg-neutral-100 transition-colors"
              name="minus"
              type="button"
              aria-label="{{ 'products.product.quantity.decrease' | t: product: item.product.title | escape }}"
              {% if item.instructions and item.instructions.can_update_quantity == false %}
                disabled
              {% endif %}
            >
              <span class="svg-wrapper w-4 h-4">
                {{- 'icon-minus.svg' | inline_asset_content -}}
              </span>
            </button>
            <input
              class="quantity__input w-12 text-center border-x border-neutral-300 py-2"
              type="number"
              data-quantity-variant-id="{{ item.variant.id }}"
              name="updates[]"
              value="{{ item.quantity }}"
              {% # theme-check-disable %}
              data-cart-quantity="{{ cart | item_count_for_variant: item.variant.id }}"
              min="0"
              data-min="{{ item.variant.quantity_rule.min }}"
              {% if item.variant.quantity_rule.max != null %}
                max="{{ item.variant.quantity_rule.max }}"
              {% endif %}
              step="{{ item.variant.quantity_rule.increment }}"
              {% # theme-check-enable %}
              aria-label="{{ 'products.product.quantity.input_label' | t: product: item.product.title | escape }}"
              id="Drawer-quantity-{{ item.index | plus: 1 }}"
              data-index="{{ item.index | plus: 1 }}"
              {% if item.instructions and item.instructions.can_update_quantity == false %}
                disabled
              {% endif %}
            >
            <button
              class="quantity__button px-3 py-2 hover:bg-neutral-100 transition-colors"
              name="plus"
              type="button"
              aria-label="{{ 'products.product.quantity.increase' | t: product: item.product.title | escape }}"
              {% if item.instructions and item.instructions.can_update_quantity == false %}
                disabled
              {% endif %}
            >
              <span class="svg-wrapper w-4 h-4">
                {{- 'icon-plus.svg' | inline_asset_content -}}
              </span>
            </button>
          </div>
        </quantity-input>

        {%- comment -%} Quantity Rules Info {%- endcomment -%}
        {%- if has_qty_rules or has_vol_pricing -%}
          <button
            type="button"
            class="text-sm text-neutral-600 hover:text-neutral-900 flex items-center gap-1"
            aria-expanded="false"
          >
            <span class="svg-wrapper w-4 h-4">
              {{- 'icon-info.svg' | inline_asset_content -}}
            </span>
            <span class="text-xs">
              {%- if has_vol_pricing -%}
                {{ 'products.product.volume_pricing.note' | t }}
              {%- elsif has_qty_rules -%}
                {{ 'products.product.quantity.rules' | t }}
              {%- endif -%}
            </span>
          </button>
        {%- endif -%}
      </div>

      {%- comment -%} Quantity Rules Popover {%- endcomment -%}
      {%- if has_vol_pricing or has_qty_rules -%}
        <div
          class="cart-items__info global-settings-popup quantity-popover__info"
          tabindex="-1"
          hidden
        >
          {%- if has_qty_rules == false -%}
            <span class="volume-pricing-label caption">{{ 'products.product.volume_pricing.title' | t }}</span>
          {%- endif -%}
          <div class="quantity__rules caption">
            {%- if item.variant.quantity_rule.increment > 1 -%}
              <span class="divider">
                {{ 'products.product.quantity.rules.increment' | t: quantity: item.variant.quantity_rule.increment }}
              </span>
            {%- endif -%}
            {%- if item.variant.quantity_rule.min > 1 -%}
              <span class="divider">{{ 'products.product.quantity.rules.min' | t: quantity: item.variant.quantity_rule.min }}</span>
            {%- endif -%}
            {%- if item.variant.quantity_rule.max != null -%}
              <span class="divider">{{ 'products.product.quantity.rules.max' | t: quantity: item.variant.quantity_rule.max }}</span>
            {%- endif -%}
          </div>
          <button
            class="button-close button button--tertiary"
            type="button"
            aria-label="{{ 'accessibility.close' | t }}"
          >
            <span class="svg-wrapper">
              {{- 'icon-close.svg' | inline_asset_content -}}
            </span>
          </button>
          {%- if item.variant.quantity_price_breaks.size > 0 -%}
            <volume-pricing class="parent-display">
              <ul class="list-unstyled">
                <li>
                  <span>{{ item.variant.quantity_rule.min }}+</span>
                  <span>{{ item.variant.price | money_with_currency }}/ea</span>
                </li>
                {%- for price_break in item.variant.quantity_price_breaks -%}
                  <li>
                    <span>
                      {{- price_break.minimum_quantity -}}
                      <span aria-hidden="true">+</span></span
                    >
                    <span>{{ price_break.price | money_with_currency }}/ea</span>
                  </li>
                {%- endfor -%}
              </ul>
            </volume-pricing>
          {%- endif -%}
        </div>
      {%- endif -%}

      {%- comment -%} Error Message {%- endcomment -%}
      <div
        id="CartDrawer-LineItemError-{{ item.index | plus: 1 }}"
        class="cart-item__error"
        role="alert"
      >
        <small class="cart-item__error-text"></small>
        <span class="svg-wrapper">
          {{- 'icon-error.svg' | inline_asset_content -}}
        </span>
      </div>
    </quantity-popover>

    {%- comment -%} Remove Button {%- endcomment -%}
    <cart-remove-button
      id="CartDrawer-Remove-{{ item.index | plus: 1 }}"
      data-index="{{ item.index | plus: 1 }}"
    >
      <button
        type="button"
        class="text-sm text-neutral-600 hover:text-red-600 transition-colors flex items-center gap-1"
        aria-label="{{ 'cart.general.remove' | t: product: item.title | escape }}"
        data-variant-id="{{ item.variant.id }}"
        {% if item.instructions and item.instructions.can_remove == false %}
          class="hidden"
        {% endif %}
      >
        <span class="svg-wrapper w-4 h-4">
          {{- 'icon-remove.svg' | inline_asset_content -}}
        </span>
        <span>{{ 'cart.general.remove' | t }}</span>
      </button>
    </cart-remove-button>
  </div>
</div>
