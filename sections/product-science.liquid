{%- liquid
  assign science_field = product.metafields.custom.science
  assign science = null

  if science_field != blank
    assign science_value = science_field.value
    if science_value != blank
      assign science = science_value
    else
      assign science = science_field
    endif
  endif

  assign science_title = ''
  assign science_description = ''
  assign science_image = null
  assign science_studies = null

  if science
    assign science_title = science.title
    assign science_description = science.desc | default: science.description
    assign science_image = science.image
    assign studies_field = science.studies

    if studies_field != blank
      if studies_field.value != blank
        assign science_studies = studies_field.value
      else
        assign science_studies = studies_field
      endif
    endif
  endif

  assign fallback_title = 'sections.product_science.default_title' | t
  assign section_title = science_title | default: fallback_title
  assign fallback_description = 'sections.product_science.default_description' | t
  assign section_description = science_description | default: fallback_description
  assign has_description = false
  if section_description != blank
    assign has_description = true
  endif

  assign has_studies = false
  if science_studies != blank
    assign has_studies = true
  endif

  assign product_theme = product.metafields.custom.theme.value | default: 'default'
  case product_theme
    when 'recupera'
      assign product_theme_class = 'product-theme-recupera'
    when 'boost'
      assign product_theme_class = 'product-theme-boost'
    else
      assign product_theme_class = 'product-theme-default'
  endcase
-%}

<section class="py-30">
  <div class="container">
    <div class="relative overflow-hidden rounded-3xl bg-neutral-900 {{ product_theme_class }}">
      {% if science_image %}
        {% liquid
          assign default_image_alt = 'sections.product_science.image_alt' | t: title: section_title
          assign image_alt = science_image.alt | default: default_image_alt
        %}
        <div class="absolute inset-0">
          {{
            science_image
            | image_url: width: 2000
            | image_tag: alt: image_alt, class: 'h-full w-full object-cover', loading: 'lazy'
          }}
          <div class="absolute inset-0 bg-black/60"></div>
        </div>
      {% else %}
        <div class="absolute inset-0 bg-black/60"></div>
      {% endif %}

      <div class="relative z-10 flex flex-col gap-12 px-8 py-16 text-white lg:px-20 lg:py-24">
        <div class="max-w-140">
          <h2 class="text-4xl font-medium text-white">{{ section_title }}</h2>
          {% if has_description %}
            <p class="mt-4 text-base text-white/80">{{ section_description }}</p>
          {% endif %}
        </div>

        {% if has_studies %}
          <div class="flex flex-wrap gap-4">
            {% for study in science_studies %}
              {% liquid
                assign study_metric = study.metric | default: study.title
                assign study_text = study.description | default: study.desc
                assign study_source = study.source
                assign study_link = study.link
                assign study_link_url = ''
                assign study_link_label = ''

                if study_link != blank
                  if study_link.url
                    assign study_link_url = study_link.url
                    assign study_link_label = study_link.title
                  else
                    assign study_link_url = study_link
                  endif
                endif

                assign computed_link_label = study_link_label
                if computed_link_label == blank
                  assign computed_link_label = 'sections.product_science.link_label' | t
                endif
              %}

              <div class="rounded-2xl border border-white/10 bg-[var(--product-accent)] p-6 backdrop-blur">
                {% if study_metric %}
                  <p class="text-5xl font-semibold text-white">
                    {{ study_metric }}
                  </p>
                {% endif %}

                {% if study_text %}
                  <p class="mt-3 text-sm text-white/80">{{ study_text }}</p>
                {% endif %}

                {% if study_source or study_link_url %}
                  <div class="mt-5 flex flex-col gap-2 text-xs text-white/60">
                    {% if study_source %}
                      {% if study_link_url != blank %}
                        <a
                          href="{{ study_link_url }}"
                          class="font-medium text-white underline"
                          target="_blank"
                          rel="noopener"
                        >
                          {{- 'sections.product_science.source_prefix' | t: source: study_source -}}
                        </a>
                      {% else %}
                        <span class="font-medium text-white">
                          {{- 'sections.product_science.source_prefix' | t: source: study_source -}}
                        </span>
                      {% endif %}
                    {% endif %}
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</section>

{% schema %}
{
  "name": "t:sections.product_science.name",
  "tag": "section",
  "class": "product-science",
  "presets": [
    {
      "name": "t:sections.product_science.name",
      "category": "t:sections.product_science.category"
    }
  ]
}
{% endschema %}
