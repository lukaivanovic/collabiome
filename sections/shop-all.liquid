{% liquid
  assign section_id = section.settings.custom_id | default: section.id
  assign products_per_page = section.settings.products_per_page | default: 24

  # Use collection object directly (like collection.liquid does)
  # This automatically handles filtering context from URL parameters
  assign selected_collection = collection

  # Define filter options for Kozmetika collection
  assign show_filters = false
  if selected_collection.handle == 'kozmetika' or selected_collection.handle == 'cosmetics'
    assign show_filters = true
  endif
%}

<div class="container mx-auto max-w-7xl px-4 py-8 md:py-16">
  {% comment %} Collection chips navigation {% endcomment %}
  <div class="flex flex-wrap gap-2 mb-8 justify-center">
    <a
      href="{{ routes.collections_url }}/all"
      class="collection-chip {% if selected_collection.handle == 'all' %}active{% endif %}"
    >
      {{ 'collections.all' | t | default: 'Shop all' }}
    </a>
    <a
      href="{{ routes.collections_url }}/dodaci-prehrani"
      class="collection-chip {% if selected_collection.handle == 'dodaci-prehrani' %}active{% endif %}"
    >
      {{ 'collections.supplements' | t | default: 'Dodaci prehrani' }}
    </a>
    <a
      href="{{ routes.collections_url }}/kozmetika"
      class="collection-chip {% if selected_collection.handle == 'kozmetika' %}active{% endif %}"
    >
      {{ 'collections.cosmetics' | t | default: 'Kozmetika' }}
    </a>
  </div>

  {% if section.settings.title != blank %}
    <div class="text-center mb-8">
      <h1 class="text-3xl uppercase mb-2">{{ selected_collection.title }}</h1>
    </div>
  {% endif %}

  {% comment %} Main content area with filters and products {% endcomment %}
  <div class="flex flex-col md:flex-row gap-8">
    {% comment %} Filters sidebar {% endcomment %}
    {% if show_filters and section.settings.show_filters %}
      <aside class="w-full md:w-64 flex-shrink-0">
        {% render 'facets' %}
      </aside>
    {% endif %}

    {% comment %} Products grid {% endcomment %}
    <div class="flex-1">
      {% comment %} Mobile filters button {% endcomment %}
      {% if show_filters and section.settings.show_filters %}
        <button
          class="filters-trigger md:hidden mb-4 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg border border-gray-300 hover:bg-gray-200 transition-colors duration-200"
          data-drawer-trigger="filters-drawer"
        >
          <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.207A1 1 0 013 6.5V4z"></path>
          </svg>
          {{ 'filters.title' | t | default: 'Filters' }}
        </button>
      {% endif %}

      <div class="mb-4 text-sm opacity-75 product-count">
        {{ selected_collection.products_count }}
        {{ 'general.products' | t | default: 'Products' }}
      </div>

      {% if collection != blank %}
        {% comment %} Collection context - use pagination {% endcomment %}
        {% paginate selected_collection.products by products_per_page %}
          {% if selected_collection.products.size == 0 %}
            <div class="text-center py-12">
              <p class="text-lg opacity-75">
                {{ 'filters.no_products' | t | default: 'No products found with the selected filters.' }}
              </p>
              <a href="{{ selected_collection.url }}" class="inline-block mt-4 px-6 py-2 bg-black text-white rounded">
                {{ 'filters.clear_all' | t | default: 'Clear all filters' }}
              </a>
            </div>
          {% else %}
            <div
              class="grid grid-cols-[repeat(auto-fill,minmax(200px,1fr))] sm:grid-cols-[repeat(auto-fill,minmax(240px,1fr))] md:grid-cols-[repeat(auto-fill,minmax(280px,1fr))] gap-4 sm:gap-6 md:gap-8 mb-12"
              data-section-id="{{ section_id }}"
            >
              {% for product in selected_collection.products %}
                <div class="product-card">
                  {% render 'product-card', product: product %}
                </div>
              {% endfor %}
            </div>

            {% if paginate.pages > 1 %}
              <div class="text-center">
                {{ paginate | default_pagination }}
              </div>
            {% endif %}
          {% endif %}
        {% endpaginate %}
      {% else %}
        {% comment %} No collection context - show all products without pagination {% endcomment %}
        <div
          class="grid grid-cols-[repeat(auto-fill,minmax(200px,1fr))] sm:grid-cols-[repeat(auto-fill,minmax(240px,1fr))] md:grid-cols-[repeat(auto-fill,minmax(280px,1fr))] gap-4 sm:gap-6 md:gap-8 mb-12"
          data-section-id="{{ section_id }}"
        >
          {% for product in collections.all.products limit: products_per_page %}
            <div class="product-card">
              {% render 'product-card', product: product %}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>

  {% comment %} Mobile filters drawer {% endcomment %}
  {% if show_filters and section.settings.show_filters %}
    {% render 'filter-drawer',
      id: 'filters-drawer',
      position: 'right',
      title: 'Filters',
      content_class: 'filters-drawer-content'
    %}
  {% endif %}
</div>

{% stylesheet %}
  /* Collection chips */
  .collection-chip {
    padding: 0.5rem 1.5rem;
    border: 1px solid #e5e7eb;
    border-radius: 9999px;
    text-decoration: none;
    color: #374151;
    font-size: 0.875rem;
    transition: all 0.2s;
    background: white;
  }

  .collection-chip:hover {
    border-color: #9ca3af;
    background: #f9fafb;
  }

  .collection-chip.active {
    background: #000;
    color: #fff;
    border-color: #000;
  }

  /* Filter checkboxes */
  .filter-checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    padding: 0.25rem 0;
  }

  .filter-checkbox-label:hover {
    opacity: 0.8;
  }

  .filter-checkbox {
    width: 1rem;
    height: 1rem;
    cursor: pointer;
    flex-shrink: 0;
  }

  /* Mobile responsive styles */
  @media (max-width: 767px) {
    aside {
      display: none;
    }

    .filters-trigger {
      display: block;
    }
  }

  @media (min-width: 768px) {
    .filters-trigger {
      display: none;
    }
  }

  @media (max-width: 768px) {
    aside {
      order: 2;
    }

    .flex-1 {
      order: 1;
    }
  }
{% endstylesheet %}

<script src="{{ 'facets.js' | asset_url }}" defer></script>
<script src="{{ 'drawer.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "Shop All",
  "class": "shop-all__section",
  "tag": "section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Page Title",
      "default": "Shop All Products"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection",
      "info": "Select a collection to display. Leave empty to show all products."
    },
    {
      "type": "range",
      "id": "products_per_page",
      "label": "Products per page",
      "min": 12,
      "max": 48,
      "step": 6,
      "default": 24
    },
    {
      "type": "checkbox",
      "id": "show_filters",
      "label": "Show filters",
      "default": false
    }
  ],
  "presets": [
    {
      "name": "Shop All",
      "category": "Collection"
    }
  ]
}
{% endschema %}
